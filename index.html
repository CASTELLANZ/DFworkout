<!DOCTYPE html> 
 <html lang="ko"> 
 <head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"> 
    <title>ìš´ë™ í˜„í™©</title> 
    <script src="https://cdn.tailwindcss.com"></script> 
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet"> 
    <style> 
        html, body { 
            font-family: 'Noto Sans KR', sans-serif; 
            overflow-x: hidden;
        } 
        :root {
            --main-bg-color: #2c5282;
            --main-text-color: #2c5282;
        }
        .custom-teal { background-color: var(--main-bg-color); color: white; } 
        .custom-teal-border { border-color: var(--main-text-color); color: var(--main-text-color); } 
        .custom-teal-text { color: var(--main-text-color); } 
        [contenteditable]:focus { outline: none; box-shadow: 0 0 0 2px rgba(44, 82, 130, 0.5); border-radius: 4px; } 
        [contenteditable="true"]:empty:before{ content: attr(placeholder); color: #9ca3af; font-weight: normal; } 
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 1000; } 
        input[type="date"] { position: relative; background-color: transparent; border: none; color: #6b7280; padding: 0; } 
        input[type="date"]:focus { outline: none; } 
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; color: transparent; cursor: pointer; } 
        .member-item { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        .photo-grid-item { aspect-ratio: 1 / 1; }
    </style> 
 </head> 
 <body class="bg-white"> 

    <div class="w-full max-w-md mx-auto p-4"> 
        <div class="absolute top-4 right-4 flex items-center gap-2 z-20">
            <button id="logout-btn" class="text-xs text-gray-500 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
            <button id="guide-btn" class="w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center font-bold text-sm hover:bg-gray-300 transition-colors">i</button> 
        </div>

        <header class="flex flex-col items-center text-center mb-12 pt-4">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-4">ìš´ë™ í˜„í™©</h2>
            <div class="flex items-baseline gap-4 text-2xl text-gray-600">
                <div class="flex items-baseline">
                    <span id="month-number" title="ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.">00</span>
                    <span>ì›”</span>
                </div>
                <div class="flex items-baseline">
                    <span>(</span>
                    <span id="week-number" title="ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.">0</span>
                    <span>ì£¼)</span>
                </div>
            </div>
            <div class="flex items-center text-sm text-gray-500 mt-2">
                <input type="date" id="start-date">
                <span class="px-1">~</span>
                <input type="date" id="end-date">
            </div>
        </header>

        <div class="flex mb-6 border-b"> 
            <button id="certification-tab-btn" class="flex-1 py-2 text-center font-bold border-b-2 border-transparent">ì¸ì¦</button> 
            <button id="status-tab-btn" class="flex-1 py-2 text-center font-bold border-b-2 border-transparent">í˜„í™©</button> 
            <button id="ranking-tab-btn" class="flex-1 py-2 text-center font-bold border-b-2 border-transparent">ë­í‚¹</button> 
        </div> 

        <main id="content-area" class="space-y-4"></main> 

        <div id="add-member-container" class="text-center mt-4"> 
            <button id="add-member-btn" class="text-sm custom-teal-text font-semibold hover:underline">ë©¤ë²„ ì¶”ê°€</button> 
        </div>

        <hr id="main-divider" class="my-6"> 

        <footer id="main-footer" class="flex justify-end gap-4"> 
            <button id="reset-btn" class="py-3 px-6 rounded-lg font-bold bg-gray-200 text-gray-700">ê¸°ë¡ ì´ˆê¸°í™”</button> 
            <button id="copy-btn" class="py-3 px-6 rounded-lg font-bold custom-teal">í˜„í™© ë³µì‚¬</button> 
        </footer> 
    </div> 

    <!-- UI Modals & Overlays -->
    <div id="login-modal" class="modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 max-w-xs">
            <p class="mb-4 font-semibold">ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="login-name-input" class="border-2 border-gray-300 p-2 rounded-lg w-full mb-4" placeholder="ì´ë¦„">
            <button id="login-confirm-btn" class="w-full px-4 py-2 custom-teal text-white rounded-lg">ì…ì¥</button>
        </div>
    </div>

    <div id="photo-viewer-modal" class="modal-overlay">
        <div class="w-full h-full p-4 flex items-center justify-center">
            <img id="photo-viewer-img" src="" class="max-w-full max-h-full object-contain">
            <button id="photo-viewer-close-btn" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        </div>
    </div>

    <div id="toast-message" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 text-sm whitespace-nowrap"></div> 
    <div id="guide-modal" class="modal-overlay"> 
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg relative"> 
            <button id="close-guide-btn" class="absolute top-2 right-3 text-3xl font-light text-gray-500 hover:text-gray-800">&times;</button> 
            <h2 class="text-2xl font-bold mb-4 text-center">ê°€ì´ë“œ</h2> 
            <div class="space-y-4 text-left max-h-[70vh] overflow-y-auto pr-2"> 
                <div> 
                    <h3 class="font-semibold text-lg text-gray-800">ì°¸ê³ ì‚¬í•­</h3> 
                    <ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1"> 
                        <li>ë­í‚¹ì€ ëª©í‘œë¥¼ ì´ˆê³¼ ë‹¬ì„±í•œ 'ìˆœìˆ˜ ìš´ë™' íšŸìˆ˜ë¡œ ê³„ì‚°ëœ 'í¬ì¸íŠ¸' ê¸°ì¤€ì…ë‹ˆë‹¤.</li> 
                        <li>'ì•¼ê·¼'ìœ¼ë¡œ ì˜¬ë¦° íšŸìˆ˜ëŠ” ì´ íšŸìˆ˜ì—ëŠ” í¬í•¨ë˜ì§€ë§Œ, ë­í‚¹ í¬ì¸íŠ¸ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li> 
                        <li>í¬ì¸íŠ¸ ë™ì  ì‹œ, 'ì•¼ê·¼' íšŸìˆ˜ê°€ ì ì€ ì‚¬ëŒì´ ë” ë†’ì€ ìˆœìœ„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.</li> 
                        <li>ì´ íšŸìˆ˜ ë™ì  ì‹œì—ë„ 'ì•¼ê·¼' íšŸìˆ˜ê°€ ì ì€ ì‚¬ëŒì´ ë” ë†’ì€ ìˆœìœ„ë¥¼ ê°€ì§‘ë‹ˆë‹¤.</li> 
                    </ul> 
                </div> 
                <hr class="my-3"> 
                <div> 
                    <h3 class="font-semibold text-lg text-gray-800">ìš´ì˜ ê°€ì´ë“œ</h3> 
                    <div id="custom-guide-area" contenteditable="true" class="mt-2 p-3 border rounded-md min-h-[150px] text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="ì—¬ê¸°ë¥¼ í´ë¦­í•´ì„œ ììœ ë¡­ê²Œ ê·œì¹™ì„ ì…ë ¥í•˜ì„¸ìš”..."></div> 
                </div> 
            </div>
            <div class="flex justify-end items-center mt-4 gap-3">
                <span id="guide-save-feedback" class="text-sm text-green-500 opacity-0 transition-opacity duration-300">ì €ì¥ ì™„ë£Œ!</span>
                <button id="save-guide-btn" class="px-4 py-2 custom-teal text-white rounded-lg font-semibold">ì €ì¥</button>
            </div>
        </div> 
    </div> 
    <div id="reset-confirm-modal" class="modal-overlay"> 
        <div class="bg-white p-6 rounded-lg shadow-xl text-center"> 
            <p class="mb-4">ì •ë§ë¡œ ëª¨ë“  ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span class="text-red-500 text-sm">(ì¸ì¦ ì‚¬ì§„ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤)</span></p> 
            <div class="flex justify-center gap-4"> 
                <button id="confirm-reset-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg">ì˜ˆ</button> 
                <button id="cancel-reset-btn" class="px-4 py-2 bg-gray-200 rounded-lg">ì•„ë‹ˆì˜¤</button> 
            </div> 
        </div> 
    </div> 
    <div id="add-member-modal" class="modal-overlay"> 
        <div class="bg-white p-6 rounded-lg shadow-xl text-center"> 
            <p class="mb-4 font-semibold">ì¶”ê°€í•  ë©¤ë²„ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p> 
            <input type="text" id="new-member-name" class="border-2 border-gray-300 p-2 rounded-lg w-full mb-4" placeholder="ì´ë¦„"> 
            <div class="flex justify-center gap-4"> 
                <button id="confirm-add-btn" class="px-4 py-2 custom-teal text-white rounded-lg">ì¶”ê°€</button> 
                <button id="cancel-add-btn" class="px-4 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button> 
            </div> 
        </div> 
    </div> 

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script> 
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "__FIREBASE_API_KEY__",
            authDomain: "__FIREBASE_AUTH_DOMAIN__",
            projectId: "__FIREBASE_PROJECT_ID__",
            storageBucket: "__FIREBASE_STORAGE_BUCKET__",
            messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
            appId: "__FIREBASE_APP_ID__"
        };

        // --- Firebase Initialization ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const membersCollection = db.collection('members');
        const photosCollection = db.collection('photos');
        const configDoc = db.collection('config').doc('guide');
        const dateDoc = db.collection('config').doc('dates');

        // --- Global State ---
        let currentPage = 'status';
        let members = [];
        let photos = [];
        let lastVisiblePhoto = null;
        let currentUser = null;
        let isAdmin = false;
        
        // --- DOM Elements ---
        const contentArea = document.getElementById('content-area'); 
        const statusTabBtn = document.getElementById('status-tab-btn'); 
        const certificationTabBtn = document.getElementById('certification-tab-btn');
        const rankingTabBtn = document.getElementById('ranking-tab-btn'); 
        const mainFooter = document.getElementById('main-footer');
        const mainDivider = document.getElementById('main-divider');
        const resetBtn = document.getElementById('reset-btn'); 
        const copyBtn = document.getElementById('copy-btn'); 
        const toastMessage = document.getElementById('toast-message'); 
        const monthNumberEl = document.getElementById('month-number'); 
        const weekNumberEl = document.getElementById('week-number'); 
        const startDateInput = document.getElementById('start-date'); 
        const endDateInput = document.getElementById('end-date'); 
        const guideBtn = document.getElementById('guide-btn'); 
        const logoutBtn = document.getElementById('logout-btn');
        const guideModal = document.getElementById('guide-modal'); 
        const closeGuideBtn = document.getElementById('close-guide-btn'); 
        const saveGuideBtn = document.getElementById('save-guide-btn');
        const resetConfirmModal = document.getElementById('reset-confirm-modal'); 
        const confirmResetBtn = document.getElementById('confirm-reset-btn'); 
        const cancelResetBtn = document.getElementById('cancel-reset-btn'); 
        const loginModal = document.getElementById('login-modal');
        const loginNameInput = document.getElementById('login-name-input');
        const loginConfirmBtn = document.getElementById('login-confirm-btn');
        const photoViewerModal = document.getElementById('photo-viewer-modal');
        const photoViewerImg = document.getElementById('photo-viewer-img');
        const photoViewerCloseBtn = document.getElementById('photo-viewer-close-btn');
        const addMemberModal = document.getElementById('add-member-modal');
        const addMemberBtn = document.querySelector('#add-member-container button');
        const confirmAddBtn = document.getElementById('confirm-add-btn');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const newMemberNameInput = document.getElementById('new-member-name');

        // --- Functions --- 

        function showToast(message) {
            toastMessage.textContent = message;
            toastMessage.classList.remove('opacity-0');
            setTimeout(() => { toastMessage.classList.add('opacity-0'); }, 2000);
        }

        function closeAllModals() {
            guideModal.style.display = 'none';
            resetConfirmModal.style.display = 'none';
            loginModal.style.display = 'none';
            photoViewerModal.style.display = 'none';
            addMemberModal.style.display = 'none';
        }

        function openModal(modal) {
            closeAllModals();
            modal.style.display = 'flex';
        }

        function saveGuideContent() {
            const content = document.getElementById('custom-guide-area').innerHTML;
            configDoc.set({ html: content }).then(() => {
                showToast('ê°€ì´ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(error => console.error("Error saving guide: ", error));
        }

        function loadGuideContent() {
            configDoc.get().then(doc => {
                if (doc.exists && doc.data().html) {
                    document.getElementById('custom-guide-area').innerHTML = doc.data().html;
                }
            }).catch(error => console.error("Error loading guide: ", error));
        }

        function loadDates() {
            dateDoc.get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if(data.startDate) startDateInput.value = data.startDate;
                    if(data.endDate) endDateInput.value = data.endDate;
                    updateDateBasedInfo(false); // Do not reset photos on initial load
                }
            }).catch(error => {
                console.error("ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            });
        }

        function updateDateBasedInfo(resetPhotos = true) { 
            const startDateVal = startDateInput.value; 
            const endDateVal = endDateInput.value; 
            if (!startDateVal || !endDateVal) return; 
            
            const startDate = new Date(startDateVal); 
            const endDate = new Date(endDateVal); 

            if (endDate < startDate) { 
                weekNumberEl.textContent = '0'; 
                monthNumberEl.textContent = '00'; 
            } else { 
                dateDoc.set({ 
                    startDate: startDateVal,
                    endDate: endDateVal
                }).then(() => {
                    if (resetPhotos && isAdmin) {
                        openModal(resetConfirmModal); // Ask for confirmation before deleting photos
                    }
                }).catch(error => console.error("ë‚ ì§œ ì €ì¥ ì‹¤íŒ¨:", error));

                const monthCounts = {}; 
                let currentDate = new Date(startDate); 
                while (currentDate <= endDate) { 
                    const month = currentDate.getMonth();
                    monthCounts[month] = (monthCounts[month] || 0) + 1; 
                    currentDate.setDate(currentDate.getDate() + 1); 
                } 
                let dominantMonth = -1, maxDays = -1; 
                for (const month in monthCounts) { 
                    if (monthCounts[month] > maxDays) { 
                        maxDays = monthCounts[month]; 
                        dominantMonth = parseInt(month, 10); 
                    } 
                } 
                monthNumberEl.textContent = String(dominantMonth + 1).padStart(2, '0'); 
                const diffTime = endDate.getTime() - startDate.getTime(); 
                const diffDays = (diffTime / (1000 * 60 * 60 * 24)) + 1; 
                const weeks = Math.ceil(diffDays / 7); 
                weekNumberEl.textContent = weeks; 
            } 
            if (currentPage === 'status') renderStatusPage(); 
            else if (currentPage === 'certification') switchPage('certification');
            else renderRankingPage(); 
        } 

        function getWeeklyGoal() { 
            const weekNumber = parseInt(weekNumberEl.textContent, 10); 
            return (isNaN(weekNumber) || weekNumber < 1) ? 4 : 4 * weekNumber; 
        } 

        function calculatePoints(member) { 
            const goalCount = getWeeklyGoal(); 
            const weekNumber = parseInt(weekNumberEl.textContent, 10) || 1; 
            const pureCount = member.count - member.overtimeCount;
            let points = 0; 
            if (pureCount > goalCount) { 
                const firstTierLimit = goalCount + weekNumber; 
                if (pureCount <= firstTierLimit) { 
                    points = (pureCount - goalCount) * 0.5; 
                } else { 
                    const firstTierPoints = (firstTierLimit - goalCount) * 0.5; 
                    const secondTierCounts = pureCount - firstTierLimit; 
                    points = firstTierPoints + (secondTierCounts * 1); 
                } 
            } 
            return points; 
        } 

        function switchPage(page) { 
            currentPage = page;
            const tabs = [statusTabBtn, certificationTabBtn, rankingTabBtn];
            const addMemberContainer = document.getElementById('add-member-container');
            
            tabs.forEach(tab => {
                tab.classList.remove('custom-teal-text', 'border-b-2', 'border-current', 'font-extrabold');
                tab.classList.add('text-gray-500');
            });

            contentArea.innerHTML = ''; 

            const showFooter = page === 'status' || page === 'ranking';
            mainFooter.style.display = showFooter ? 'flex' : 'none';
            mainDivider.style.display = showFooter ? 'block' : 'none';
            if (addMemberContainer) addMemberContainer.style.display = 'none';


            if (page === 'status') {
                statusTabBtn.classList.add('custom-teal-text', 'border-b-2', 'border-current', 'font-extrabold');
                statusTabBtn.classList.remove('text-gray-500');
                if (addMemberContainer) addMemberContainer.style.display = 'block';
                renderStatusPage();
            } else if (page === 'certification') {
                certificationTabBtn.classList.add('custom-teal-text', 'border-b-2', 'border-current', 'font-extrabold');
                certificationTabBtn.classList.remove('text-gray-500');
                renderCertificationPage();
            } else if (page === 'ranking') {
                rankingTabBtn.classList.add('custom-teal-text', 'border-b-2', 'border-current', 'font-extrabold');
                rankingTabBtn.classList.remove('text-gray-500');
                renderRankingPage(); 
            }
        } 

        function renderStatusPage() { 
            const oldOrder = Array.from(contentArea.querySelectorAll('.member-item')).map(el => el.dataset.id);
            const firstPositions = {}; 
            contentArea.querySelectorAll('.member-item').forEach(el => { 
                firstPositions[el.dataset.id] = el.getBoundingClientRect(); 
            }); 
            
            members.sort((a, b) => { 
                if (b.count !== a.count) return b.count - a.count; 
                return a.name.localeCompare(b.name, 'ko');
            }); 
            
            contentArea.innerHTML = '';
            const addMemberContainer = document.getElementById('add-member-container');
            if (addMemberContainer) addMemberContainer.style.display = 'block';

            if (!members || members.length === 0) {
                contentArea.innerHTML = `<p class="text-center text-gray-500 py-8">ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì—¬ ìš´ë™ í˜„í™© ê¸°ë¡ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>`;
                return;
            }
            members.forEach((member, index) => { 
                const memberDiv = document.createElement('div'); 
                const canEdit = isAdmin || currentUser === member.name;
                memberDiv.className = `member-item flex flex-wrap items-center justify-between p-3 rounded-lg bg-gray-100`; 
                memberDiv.dataset.id = member.id;
                
                const leftContainer = document.createElement('div'); 
                leftContainer.className = 'flex items-center gap-3 min-w-0'; 
                
                const rankSpan = document.createElement('span'); 
                rankSpan.className = `font-bold text-xl w-6 text-center text-gray-500 flex-shrink-0`; 
                rankSpan.textContent = `#${index + 1}`; 
                leftContainer.appendChild(rankSpan); 
                
                const nameContainer = document.createElement('div'); 
                nameContainer.className = 'flex flex-col items-start truncate'; 
                
                const nameSpan = document.createElement('span'); 
                nameSpan.className = `font-bold text-lg text-gray-800 truncate ${canEdit ? 'cursor-pointer' : ''}`; 
                nameSpan.textContent = member.name; 
                nameSpan.contentEditable = canEdit; 
                nameSpan.setAttribute('placeholder', 'ì´ë¦„ ì…ë ¥...');
                nameSpan.onblur = (e) => { 
                    if (canEdit) {
                        const newName = e.target.textContent.trim();
                        membersCollection.doc(member.id).update({ name: newName });
                    }
                }; 
                nameContainer.appendChild(nameSpan); 
                
                const subTextParts = []; 
                if (member.overtimeCount > 0) subTextParts.push(`ì•¼ê·¼ ${member.overtimeCount}íšŒ`); 
                if (member.restCount > 0) subTextParts.push(`íœ´ì‹ ${member.restCount}íšŒ`); 
                if (subTextParts.length > 0) { 
                    const subTextSpan = document.createElement('span'); 
                    subTextSpan.className = 'text-xs text-gray-500 mt-1 truncate'; 
                    subTextSpan.textContent = `(${subTextParts.join(', ')})`; 
                    nameContainer.appendChild(subTextSpan); 
                } 
                leftContainer.appendChild(nameContainer); 
                
                const rightDiv = document.createElement('div'); 
                rightDiv.className = 'flex items-center gap-2 flex-shrink-0 ml-auto'; 
                
                const countText = document.createElement('span'); 
                countText.className = 'text-lg text-right whitespace-nowrap'; 
                countText.innerHTML = `<span class="font-bold text-xl custom-teal-text">${member.count}</span><span class="text-gray-500">íšŒ / ${getWeeklyGoal()}íšŒ</span>`; 
                
                const controlsContainer = document.createElement('div'); 
                controlsContainer.className = 'flex items-center gap-2'; 
                
                if (canEdit) {
                    const plusButton = document.createElement('button'); 
                    plusButton.className = 'w-8 h-8 rounded-full custom-teal text-white text-xl font-bold flex items-center justify-center transition-transform duration-200 hover:scale-110 active:scale-95'; 
                    plusButton.textContent = '+'; 
                    plusButton.onclick = () => updateRecord(member.id, 'workout', 1); 
                    controlsContainer.appendChild(plusButton); 
                    
                    const etcContainer = document.createElement('div'); 
                    etcContainer.className = 'relative'; 
                    const etcButton = document.createElement('button'); 
                    etcButton.className = 'px-3 py-1 rounded-md text-sm bg-gray-300 font-semibold transition-transform duration-200 hover:scale-105 active:scale-95'; 
                    etcButton.textContent = 'ê¸°íƒ€'; 
                    etcButton.onclick = (e) => { e.stopPropagation(); toggleDropdown(member.id); }; 
                    etcContainer.appendChild(etcButton); 
                    const dropdownMenu = createDropdownMenu(member); 
                    etcContainer.appendChild(dropdownMenu); 
                    controlsContainer.appendChild(etcContainer); 
                }
                
                rightDiv.appendChild(countText); 
                rightDiv.appendChild(controlsContainer); 
                
                memberDiv.appendChild(leftContainer); 
                memberDiv.appendChild(rightDiv); 
                contentArea.appendChild(memberDiv); 
            }); 
            
            const memberItems = contentArea.querySelectorAll('.member-item'); 
            memberItems.forEach((el, newIndex) => { 
                const id = el.dataset.id; 
                const oldIndex = oldOrder.indexOf(id);
                
                if (oldIndex !== -1 && oldIndex !== newIndex) {
                    const first = firstPositions[id]; 
                    if (!first) return; 
                    const last = el.getBoundingClientRect(); 
                    const dx = first.left - last.left; 
                    const dy = first.top - last.top; 

                    if (Math.abs(dx) > 0.1 || Math.abs(dy) > 0.1) { 
                        el.style.transform = `translate(${dx}px, ${dy}px)`; 
                        el.style.transition = 'transform 0s'; 
                        requestAnimationFrame(() => { 
                            el.style.transform = ''; 
                            el.style.transition = 'transform 0.5s ease-in-out'; 
                        }); 
                    } 
                }
            }); 
        } 

        function renderRankingPage() { 
            contentArea.innerHTML = ''; 
            const addMemberContainer = document.getElementById('add-member-container');
            if (addMemberContainer) addMemberContainer.style.display = 'none';

            if (!members || members.length === 0) {
                contentArea.innerHTML = `<p class="text-center text-gray-500 py-8">ë©¤ë²„ê°€ ì—†ì–´ ë­í‚¹ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            const rankedMembers = members.map(member => ({ 
                ...member, 
                points: calculatePoints(member) 
            })).sort((a, b) => { 
                if(b.points !== a.points) return b.points - a.points; 
                return a.overtimeCount - b.overtimeCount; 
            }); 
            const topRankers = rankedMembers.slice(0, 3); 
            const otherRankers = rankedMembers.slice(3); 
            const podium = document.createElement('div'); 
            podium.className = 'flex justify-center items-end gap-2 mt-4 mb-8'; 
            const displayOrder = [1, 0, 2]; 
            const podiumHeights = ['h-32', 'h-24', 'h-20']; 
            const podiumColors = ['bg-yellow-500', 'bg-gray-400', 'bg-yellow-600']; 
            const podiumMedals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰']; 
            displayOrder.forEach(orderIndex => {
                const member = topRankers[orderIndex];
                const rankIndex = member ? rankedMembers.indexOf(member) : -1;
                const podiumUnitContainer = document.createElement('div');
                podiumUnitContainer.className = 'w-1/3 flex flex-col items-center';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'font-bold text-lg mb-1 truncate w-full text-center text-gray-800 h-7';
                const podiumBlock = document.createElement('div');
                let heightClass = 'h-16';
                if(rankIndex !== -1) {
                    if (rankIndex === 0) heightClass = podiumHeights[0];
                    else if (rankIndex === 1) heightClass = podiumHeights[1];
                    else if (rankIndex === 2) heightClass = podiumHeights[2];
                }
                
                podiumBlock.className = `w-full ${heightClass} rounded-t-lg flex flex-col items-center justify-center p-2 text-white shadow-lg`;
                if (member) {
                    nameSpan.textContent = member.name;
                    podiumBlock.classList.add(podiumColors[rankIndex]);
                    const medalSpan = document.createElement('span');
                    medalSpan.className = 'text-3xl';
                    medalSpan.textContent = podiumMedals[rankIndex];
                    podiumBlock.appendChild(medalSpan);
                    const pointSpan = document.createElement('span');
                    pointSpan.className = 'text-sm font-semibold mt-1';
                    pointSpan.textContent = `${member.points}pt`;
                    podiumBlock.appendChild(pointSpan);
                } else {
                    podiumBlock.classList.add('bg-gray-200');
                }
                podiumUnitContainer.appendChild(nameSpan);
                podiumUnitContainer.appendChild(podiumBlock);
                podium.appendChild(podiumUnitContainer);
            });
            contentArea.appendChild(podium); 
            if (otherRankers.length > 0) { 
                const listContainer = document.createElement('div'); 
                listContainer.className = 'space-y-2'; 
                otherRankers.forEach((member, index) => { 
                    const rank = index + 4; 
                    const listItem = document.createElement('div'); 
                    listItem.className = 'flex items-center justify-between p-3 rounded-lg bg-gray-100'; 
                    const leftDiv = document.createElement('div'); 
                    leftDiv.className = 'flex items-center gap-3'; 
                    const rankSpan = document.createElement('span'); 
                    rankSpan.className = 'font-bold text-lg w-6 text-center text-gray-500'; 
                    rankSpan.textContent = `#${rank}`; 
                    leftDiv.appendChild(rankSpan); 
                    const nameSpan = document.createElement('span'); 
                    nameSpan.className = 'font-semibold text-gray-800'; 
                    nameSpan.textContent = member.name; 
                    leftDiv.appendChild(nameSpan); 
                    listItem.appendChild(leftDiv); 
                    const pointSpan = document.createElement('span'); 
                    pointSpan.className = 'font-bold text-lg custom-teal-text'; 
                    pointSpan.textContent = `${member.points}pt`; 
                    listItem.appendChild(pointSpan); 
                    listContainer.appendChild(listItem); 
                }); 
                contentArea.appendChild(listContainer); 
            } 
        } 

        function renderCertificationPage() {
            contentArea.innerHTML = `
                <div class="flex justify-end">
                    <label for="photo-upload-input" class="px-4 py-2 custom-teal text-white rounded-lg font-semibold cursor-pointer">+ ì‚¬ì§„ ë“±ë¡</label>
                    <input type="file" id="photo-upload-input" class="hidden" accept="image/*">
                </div>
                <div id="photo-grid" class="grid grid-cols-3 gap-1"></div>
                <div id="load-more-container" class="text-center mt-4">
                    <button id="load-more-photos-btn" class="text-sm custom-teal-text font-semibold hover:underline">ë”ë³´ê¸°</button>
                </div>
            `;
            
            photos = [];
            lastVisiblePhoto = null;
            loadPhotos(); 

            document.getElementById('photo-upload-input').addEventListener('change', handlePhotoUpload);
            document.getElementById('load-more-photos-btn').addEventListener('click', () => loadPhotos(lastVisiblePhoto));
        }

        function loadPhotos(startAfterDoc = null) {
            let query = photosCollection.orderBy('createdAt', 'desc').limit(9);
            if (startAfterDoc) {
                query = query.startAfter(startAfterDoc);
            }

            query.get().then(snapshot => {
                const loadMoreBtn = document.getElementById('load-more-photos-btn');
                if (snapshot.empty) {
                    if (loadMoreBtn) loadMoreBtn.textContent = 'ë§ˆì§€ë§‰ ì‚¬ì§„ì…ë‹ˆë‹¤.';
                    if(photos.length === 0) {
                        document.getElementById('photo-grid').innerHTML = `<p class="col-span-3 text-center text-gray-500 py-8">ë“±ë¡ëœ ì¸ì¦ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                    return;
                }
                
                lastVisiblePhoto = snapshot.docs[snapshot.docs.length - 1];
                const grid = document.getElementById('photo-grid');

                snapshot.forEach(doc => {
                    const photo = { id: doc.id, ...doc.data() };
                    photos.push(photo);
                    
                    const item = document.createElement('div');
                    item.className = 'photo-grid-item relative bg-gray-200 cursor-pointer group';
                    item.innerHTML = `
                        <img src="${photo.url}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 w-full bg-black bg-opacity-50 text-white p-1 text-xs truncate opacity-0 group-hover:opacity-100 transition-opacity">
                            <span>${photo.userName}</span>
                            <span class="float-right">${new Date(photo.createdAt.seconds * 1000).toLocaleDateString('ko-KR')}</span>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        photoViewerImg.src = photo.url;
                        openModal(photoViewerModal);
                    });
                    grid.appendChild(item);
                });
            });
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...');
            const filePath = `photos/${Date.now()}_${file.name}`;
            const fileRef = storage.ref(filePath);
            
            fileRef.put(file).then(() => {
                fileRef.getDownloadURL().then(url => {
                    photosCollection.add({
                        url: url,
                        storagePath: filePath,
                        userName: currentUser,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then((docRef) => {
                        showToast('ì—…ë¡œë“œ ì™„ë£Œ!');
                        // Optimistic UI update
                        const grid = document.getElementById('photo-grid');
                        const emptyMessage = grid.querySelector('p');
                        if (emptyMessage) emptyMessage.remove();

                        const newPhoto = {
                            id: docRef.id,
                            url: url,
                            userName: currentUser,
                            createdAt: { seconds: Date.now() / 1000 }
                        };
                        photos.unshift(newPhoto);

                        const item = document.createElement('div');
                        item.className = 'photo-grid-item relative bg-gray-200 cursor-pointer group';
                        item.innerHTML = `
                            <img src="${newPhoto.url}" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 w-full bg-black bg-opacity-50 text-white p-1 text-xs truncate opacity-0 group-hover:opacity-100 transition-opacity">
                                <span>${newPhoto.userName}</span>
                                <span class="float-right">${new Date(newPhoto.createdAt.seconds * 1000).toLocaleDateString('ko-KR')}</span>
                            </div>
                        `;
                        item.addEventListener('click', () => {
                            photoViewerImg.src = newPhoto.url;
                            openModal(photoViewerModal);
                        });
                        grid.prepend(item);
                    });
                });
            }).catch(error => {
                console.error("Upload failed: ", error)
                showToast('ì—…ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            });
        }

        function createDropdownMenu(member) { 
            const dropdownMenu = document.createElement('div'); 
            dropdownMenu.id = `dropdown-${member.id}`; 
            dropdownMenu.className = 'hidden absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg z-10'; 
            const baseItemClass = 'block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed'; 
            const overtimeItem = document.createElement('button'); 
            overtimeItem.className = baseItemClass; 
            overtimeItem.textContent = 'ì•¼ê·¼'; 
            overtimeItem.onclick = () => { updateRecord(member.id, 'overtime', 1); toggleDropdown(member.id, true); }; 
            dropdownMenu.appendChild(overtimeItem); 
            const restItem = document.createElement('button'); 
            restItem.className = baseItemClass; 
            restItem.textContent = 'íœ´ì‹'; 
            restItem.onclick = () => { updateRecord(member.id, 'rest', 1); toggleDropdown(member.id, true); }; 
            dropdownMenu.appendChild(restItem); 
            const divider = document.createElement('hr'); 
            divider.className = 'my-1'; 
            dropdownMenu.appendChild(divider); 
            const workoutCancelItem = document.createElement('button'); 
            workoutCancelItem.className = baseItemClass; 
            workoutCancelItem.textContent = 'ìš´ë™ ì·¨ì†Œ'; 
            workoutCancelItem.disabled = (member.count - member.overtimeCount) <= 0; 
            workoutCancelItem.onclick = () => { updateRecord(member.id, 'workout', -1); toggleDropdown(member.id, true); }; 
            dropdownMenu.appendChild(workoutCancelItem); 
            const overtimeCancelItem = document.createElement('button'); 
            overtimeCancelItem.className = baseItemClass; 
            overtimeCancelItem.textContent = 'ì•¼ê·¼ ì·¨ì†Œ'; 
            overtimeCancelItem.disabled = member.overtimeCount <= 0; 
            overtimeCancelItem.onclick = () => { updateRecord(member.id, 'overtime', -1); toggleDropdown(member.id, true); }; 
            dropdownMenu.appendChild(overtimeCancelItem); 
            const restCancelItem = document.createElement('button'); 
            restCancelItem.className = baseItemClass; 
            restCancelItem.textContent = 'íœ´ì‹ ì·¨ì†Œ'; 
            restCancelItem.disabled = member.restCount <= 0; 
            restCancelItem.onclick = () => { updateRecord(member.id, 'rest', -1); toggleDropdown(member.id, true); }; 
            dropdownMenu.appendChild(restCancelItem); 
            return dropdownMenu; 
        } 
        
        function toggleDropdown(id, forceClose = false) { 
            const dropdown = document.getElementById(`dropdown-${id}`); 
            if (!dropdown) return; 
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => { 
                if (d.id !== `dropdown-${id}`) d.classList.add('hidden'); 
            }); 
            if (forceClose) dropdown.classList.add('hidden'); 
            else dropdown.classList.toggle('hidden'); 
        } 

        function updateRecord(id, type, amount) {
            const memberDoc = membersCollection.doc(id);
            const valueToUpdate = firebase.firestore.FieldValue.increment(amount);

            if (type === 'workout') {
                const member = members.find(m => m.id === id);
                if (amount < 0 && (!member || (member.count - member.overtimeCount) <= 0)) return; 
                memberDoc.update({ count: valueToUpdate });
            } else if (type === 'overtime') {
                const member = members.find(m => m.id === id);
                if (amount < 0 && (!member || member.overtimeCount <= 0)) return;
                memberDoc.update({ count: valueToUpdate, overtimeCount: valueToUpdate });
            } else if (type === 'rest') {
                const member = members.find(m => m.id === id);
                if (amount < 0 && (!member || member.restCount <= 0)) return;
                memberDoc.update({ restCount: valueToUpdate });
            }
        }

        function addMember(name) { 
            if (name && isAdmin) { 
                membersCollection.add({
                    name: name,
                    count: 0,
                    overtimeCount: 0,
                    restCount: 0,
                }).catch(error => console.error("Error adding member: ", error));
            } 
        } 

        function resetAllData() {
            // 1. Delete all photos
            photosCollection.get().then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => {
                    const path = doc.data().storagePath;
                    if (path) {
                        storage.ref(path).delete().catch(e => console.error("Failed to delete file:", e));
                    }
                    batch.delete(doc.ref);
                });
                return batch.commit();
            });
            // 2. Reset member counts
            membersCollection.get().then(snapshot => {
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { count: 0, overtimeCount: 0, restCount: 0 });
                });
                return batch.commit();
            });
        } 

        function copyStatus() { 
            const weeklyGoal = getWeeklyGoal(); 
            const monthNumber = document.getElementById('month-number').textContent || '00'; 
            const weekNumber = weekNumberEl.textContent || '0'; 
            const startDate = startDateInput.value; 
            const endDate = endDateInput.value; 
            const formattedStartDate = startDate ? startDate.replaceAll('-', '.') : 'ì‹œì‘ì¼'; 
            const formattedEndDate = endDate ? endDate.replaceAll('-', '.') : 'ì¢…ë£Œì¼'; 
            const dateRangeText = `${formattedStartDate} ~ ${formattedEndDate}`; 
            let textToCopy = ``; 
            if (currentPage === 'status') { 
                textToCopy = `[${monthNumber}ì›” (${weekNumber}ì£¼) ìš´ë™ í˜„í™© (${dateRangeText})]\n\n`; 
                const sortedMembers = [...members].sort((a,b) => { 
                    if(b.count !== a.count) return b.count - a.count; 
                    return a.name.localeCompare(b.name, 'ko');
                });
                sortedMembers.forEach((member, index) => { 
                    let status = `#${index + 1} ${member.name}: ${member.count}íšŒ / ${weeklyGoal}íšŒ`; 
                    const subTextParts = []; 
                    if (member.overtimeCount > 0) subTextParts.push(`ì•¼ê·¼ ${member.overtimeCount}íšŒ`); 
                    if (member.restCount > 0) subTextParts.push(`íœ´ì‹ ${member.restCount}íšŒ`); 
                    if (subTextParts.length > 0) status += ` (${subTextParts.join(', ')})`; 
                    textToCopy += status + '\n'; 
                }); 
            } else { 
                textToCopy = `[${monthNumber}ì›” (${weekNumber}ì£¼) ë­í‚¹ (${dateRangeText})]\n\n`; 
                const rankedMembers = members.map(member => ({...member, points: calculatePoints(member)})).sort((a, b) => { 
                    if(b.points !== a.points) return b.points - a.points; 
                    return a.overtimeCount - b.overtimeCount; 
                }); 
                rankedMembers.forEach((member, index) => { 
                    let rankText = `#${index + 1} ${member.name}: ${member.points}pt`; 
                    if (index === 0) rankText = `ğŸ¥‡ ${rankText}`; 
                    if (index === 1) rankText = `ğŸ¥ˆ ${rankText}`; 
                    if (index === 2) rankText = `ğŸ¥‰ ${rankText}`; 
                    textToCopy += rankText + '\n'; 
                }); 
            } 
            const textarea = document.createElement('textarea'); 
            textarea.value = textToCopy; 
            document.body.appendChild(textarea); 
            textarea.select(); 
            document.execCommand('copy'); 
            document.body.removeChild(textarea); 
            showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        } 

        function logout() {
            localStorage.removeItem('workoutTrackerUser');
            window.location.reload();
        }

        // --- Event Listeners ---
        startDateInput.addEventListener('change', () => updateDateBasedInfo(true)); 
        endDateInput.addEventListener('change', () => updateDateBasedInfo(true)); 
        statusTabBtn.addEventListener('click', () => switchPage('status')); 
        certificationTabBtn.addEventListener('click', () => switchPage('certification'));
        rankingTabBtn.addEventListener('click', () => switchPage('ranking')); 
        guideBtn.addEventListener('click', () => openModal(guideModal)); 
        logoutBtn.addEventListener('click', logout);
        closeGuideBtn.addEventListener('click', closeAllModals); 
        saveGuideBtn.addEventListener('click', saveGuideContent);
        addMemberBtn.addEventListener('click', () => openModal(addMemberModal)); 
        confirmAddBtn.addEventListener('click', () => { 
            const newName = newMemberNameInput.value.trim(); 
            if (newName) { 
                addMember(newName); 
                newMemberNameInput.value = ''; 
                closeAllModals(); 
            } 
        }); 
        cancelAddBtn.addEventListener('click', () => { 
            newMemberNameInput.value = ''; 
            closeAllModals(); 
        }); 
        resetBtn.addEventListener('click', () => openModal(resetConfirmModal)); 
        confirmResetBtn.addEventListener('click', () => { 
            resetAllData(); 
            closeAllModals(); 
        }); 
        cancelResetBtn.addEventListener('click', closeAllModals); 
        copyBtn.addEventListener('click', copyStatus); 
        photoViewerCloseBtn.addEventListener('click', closeAllModals);
        
        loginConfirmBtn.addEventListener('click', () => {
            const name = loginNameInput.value.trim();
            if (name) {
                currentUser = name;
                isAdmin = name.toUpperCase() === 'ADMIN';
                localStorage.setItem('workoutTrackerUser', name);
                closeAllModals();
                initializeApp();
            }
        });
        loginNameInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') loginConfirmBtn.click();
        });

        // --- App Initialization ---
        function checkLogin() {
            const storedUser = localStorage.getItem('workoutTrackerUser');
            if (storedUser) {
                currentUser = storedUser;
                isAdmin = storedUser.toUpperCase() === 'ADMIN';
                initializeApp();
            } else {
                openModal(loginModal);
            }
        }
        
        function initializeApp() {
            loadGuideContent();
            loadDates();

            membersCollection.onSnapshot(snapshot => {
                let fetchedMembers = [];
                snapshot.forEach(doc => {
                    fetchedMembers.push({ id: doc.id, ...doc.data() });
                });
                members = fetchedMembers;
                switchPage(currentPage);
            }, error => {
                console.error("Error fetching members: ", error);
            });
            
            switchPage('status'); // Set initial page to 'status'
        }
        
        window.onload = checkLogin;
    </script> 
 </body> 
 </html>
